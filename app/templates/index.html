<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elector-igami Probability</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 20px;
        }
        h1 {
            text-align: center;
            width: 100%;
        }
        #outcomes-text {
            text-align: center;
            font-size: 24px;
            margin: 20px 0;
            font-weight: bold;
        }
        #twitter-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
        }
        #twitter-icon:hover {
            opacity: 0.8;
        }
        #gauge-chart {
            width: 100%;
            max-width: 600px; /* Adjust this value as needed */
            margin: 0 auto;
        }

        /* Flexbox container for images */
        .map-container {
            display: flex;
            justify-content: space-between;
            margin-top: 40px; /* Increased top margin */
            padding: 0 5%; /* Added horizontal padding */
            max-width: 1200px;
        }

        /* Style for each image wrapper */
        .map-wrapper {
            width: 40%; /* Reduced from 45% to create more space between */
            text-align: center;
        }

        /* Style for each image */
        .map-image {
            width: 100%;
            height: auto;
            margin-top: 10px;
        }

        /* Style for image labels */
        .map-label {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px; /* Increased bottom margin */
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Presidential Election Electoral College-igami Probability</h1>
    <a href="https://x.com/patricktaylor05" target="_blank" id="twitter-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
    </a>
    <div id="outcomes-text">Based on <span id="outcomes-count">0</span> possible outcomes</div>
    <div id="gauge-chart"></div>

    <!-- Flex container for the two images with labels -->
    <div class="map-container">
        <!-- True map on the left -->
        <div class="map-wrapper">
            <div class="map-label">Most likely scorigami</div>
            <img src="/map/true" alt="True Map" class="map-image">
        </div>
        <!-- False map on the right -->
        <div class="map-wrapper">
            <div class="map-label">Most likely non-scorigami</div>
            <img src="/map/false" alt="False Map" class="map-image">
        </div>
    </div>

    <script>
        var chartJSON = {{ chart_json | safe }};
        var finalValue = chartJSON.data[0].value;
        var totalOutcomes = BigInt("72057594037927900");  // Use BigInt for precise large number handling

        // Set initial value to 0
        chartJSON.data[0].value = 0;
        chartJSON.data[0].gauge.threshold.value = 0; //value is correct here

        // Function to animate the outcomes count
        function animateOutcomes(current) {
            if (current <= totalOutcomes) {
                document.getElementById('outcomes-count').textContent = current.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                setTimeout(() => animateOutcomes(current + totalOutcomes / 200n), 25);
            }
        }

        // Start the outcomes animation
        animateOutcomes(BigInt(0));

        function updateChart() {
            fetch('/update_chart', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Fetch the updated chart data
                        return fetch('/');
                    }
                })
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newChartJSON = JSON.parse(doc.getElementById('chart-data').textContent);

                    // Update the chart
                    Plotly.react('gauge-chart', newChartJSON.data, newChartJSON.layout);
                })
                .catch(error => console.error('Error updating chart:', error));
        }

        Plotly.newPlot('gauge-chart', chartJSON.data, {
            ...chartJSON.layout,
            datarevision: new Date().getTime(),  // Force the chart to re-render
            gauge: {
                axis: { visible: false },  // Hide the ticks if you don't want them
            },
            number: { valueformat: '.2f', suffix: '%' },
            width: 600,
            height: 400,
            margin: { t: 0, b: 0, l: 0, r: 0 }
        }).then(function() {
            function animateGauge(value) {
                // Set large increments if the value is far from the final value
                let increment = (finalValue - value > 1) ? 0.37 : 0.01;  // Use 1 until the finalValue is close, then switch to 0.01

                if (value <= finalValue) {
                    Plotly.animate('gauge-chart', {
                        data: [{
                            value: value,
                            gauge: {
                                threshold: { value: value },
                            }
                        }],
                        traces: [0],
                        layout: {}
                    }, {
                        transition: { duration: 0 },  // Instant transition between frames
                        frame: { duration: 0, redraw: false }
                    });

                    // Increment by the chosen value and continue animation
                    setTimeout(function() { animateGauge(value + increment); }, 0);
                }
            }

            // Start the gauge animation
            animateGauge(0);
        });

        // Update the chart every 10 minutes
        setInterval(updateChart, 600000);
    </script>
</body>
</html>