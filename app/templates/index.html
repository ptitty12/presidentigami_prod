<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elector-igami Probability</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 16px;
        }
        h1 {
            font-size: 1.5rem;
            text-align: center;
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        #outcomes-text {
            text-align: center;
            font-size: 1.2rem;
            margin: 1rem 0;
            font-weight: bold;
        }
        #twitter-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.5rem;
            height: 1.5rem;
        }
        #twitter-icon:hover {
            opacity: 0.8;
        }
        #gauge-chart, #line-chart {
            width: 100%;
            max-width: 100vw;
            height: 50vh;
            margin: 0 auto;
        }
        .map-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: 2rem;
            padding: 0 1rem;
        }
        .map-wrapper {
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
        }
        .map-image {
            width: 100%;
            height: auto;
        }
        .map-label {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            #outcomes-text {
                font-size: 1.5rem;
            }
            .map-container {
                flex-direction: row;
                justify-content: space-around;
            }
            .map-wrapper {
                width: 45%;
            }
            .map-label {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <h1>Presidential Election Electoral College-igami Probability</h1>
    <a href="https://x.com/patricktaylor05" target="_blank" id="twitter-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
    </a>
    <div id="outcomes-text">Based on <span id="outcomes-count">0</span> possible outcomes.</div>
    <div id="gauge-chart"></div>
    <div id="line-chart"></div>

    <div class="map-container">
        <div class="map-wrapper">
            <div class="map-label">Most likely scorigami</div>
            <img src="/map/true" alt="True Map" class="map-image">
        </div>
        <div class="map-wrapper">
            <div class="map-label">Most likely non-scorigami</div>
            <img src="/map/false" alt="False Map" class="map-image">
        </div>
    </div>

     <script>
        var chartJSON = {{ chart_json | safe }};
        var lineChartJSON = {{ line_chart_json | safe }};

        var finalValue = chartJSON.data[0].value;
        var totalOutcomes = BigInt("72057594037927900");  // Use BigInt for precise large number handling

        // Set initial value to 0
        chartJSON.data[0].value = 0;
        chartJSON.data[0].gauge.threshold.value = 0; //value is correct here

        // Function to animate the outcomes count
        function animateOutcomes(current) {
            if (current <= totalOutcomes) {
                document.getElementById('outcomes-count').textContent = current.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                setTimeout(() => animateOutcomes(current + totalOutcomes / 200n), 25);
            }
        }

        // Start the outcomes animation
        animateOutcomes(BigInt(0));

        var config = {responsive: true};

        Plotly.newPlot('gauge-chart', chartJSON.data, {
            ...chartJSON.layout,
            datarevision: new Date().getTime(),  // Force the chart to re-render
            gauge: {
                axis: { visible: false },  // Hide the ticks if you don't want them
            },
            number: { valueformat: '.2f', suffix: '%' },
            margin: { t: 0, b: 0, l: 0, r: 0 }
        }, config).then(function() {
            function animateGauge(value) {
                // Set large increments if the value is far from the final value
                let increment = (finalValue - value > 1) ? 0.37 : 0.01;  // Use 1 until the finalValue is close, then switch to 0.01

                if (value <= finalValue) {
                    Plotly.animate('gauge-chart', {
                        data: [{
                            value: value,
                            gauge: {
                                threshold: { value: value },
                            }
                        }],
                        traces: [0],
                        layout: {}
                    }, {
                        transition: { duration: 0 },  // Instant transition between frames
                        frame: { duration: 0, redraw: false }
                    });

                    // Increment by the chosen value and continue animation
                    setTimeout(function() { animateGauge(value + increment); }, 0);
                }
            }

            // Start the gauge animation
            animateGauge(0);
        });

        // Create the line chart
        Plotly.newPlot('line-chart', lineChartJSON.data, lineChartJSON.layout, config)
            .then(function() {
                console.log('Line chart created successfully');
            })
            .catch(function(err) {
                console.error('Error creating line chart:', err);
            });

        function updateChart() {
            fetch('/update_chart', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        return fetch('/');
                    }
                })
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newChartJSON = JSON.parse(doc.getElementById('chart-data').textContent);

                    // Update the gauge chart
                    Plotly.react('gauge-chart', newChartJSON.data, newChartJSON.layout, config);

                    // Update the line chart
                    const newLineChartJSON = JSON.parse(doc.getElementById('line-chart-data').textContent);
                    Plotly.react('line-chart', newLineChartJSON.data, newLineChartJSON.layout, config);
                })
                .catch(error => console.error('Error updating charts:', error));
        }

        // Update the chart every 10 minutes
        setInterval(updateChart, 600000);
    </script>
</body>
</html>